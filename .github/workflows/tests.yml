name: Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc g++ build-essential

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel cython
        # Install with minimal dependencies first for basic tests
        pip install numpy scipy networkx tqdm bitarray rdflib
        # Try to install visualization dependencies (may fail on some Python versions)
        pip install matplotlib==3.6.0rc1 || pip install matplotlib
        pip install plotnine seaborn || true
        pip install gensim scikit-learn || true

    - name: Install package
      run: |
        pip install -e .

    - name: Run tests
      run: |
        python run_tests.py

    - name: Upload test results
      if: always()
      run: |
        echo "Test execution completed"
        echo "Check the logs above for detailed test results"

  test-minimal:
    runs-on: ubuntu-latest
    name: "Test with minimal dependencies (Python 3.8)"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: "3.8"

    - name: Install minimal dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel
        # Only install absolutely required dependencies
        pip install numpy scipy networkx tqdm bitarray rdflib

    - name: Install package (minimal)
      run: |
        pip install -e . --no-deps

    - name: Run tests (minimal)
      run: |
        python run_tests.py
        echo "âœ… Minimal dependency tests completed"
        echo "Note: Some tests may be skipped due to missing optional dependencies"